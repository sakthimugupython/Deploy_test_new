{% extends 'shop/base.html' %}
{% block content %}
<section class="cart-section py-5">
    <div class="container">
        {% if alert_message %}
        <div class="alert alert-warning alert-dismissible fade show text-center" role="alert">
            {{ alert_message }}
            <a href="/login/" class="btn btn-info btn-sm ms-2">Login</a>
        </div>
        {% endif %}
        {% if not cart_items %}
        <div class="alert alert-info text-center" role="alert">
            Your cart is currently empty.<br>
            <a href="/offers/" class="btn btn-info mt-3">Continue Shopping</a>
        </div>
        {% else %}
        <form method="post">
            {% csrf_token %}
            <div class="row">
                <div class="col-12">
                    <table class="table align-middle" style="border-color:#0BD4EB;">
                        <thead class="table-light">
                            <tr style="border-width:2px;border-color:#0BD4EB;">
                                <th>Product</th>
                                <th>Price</th>
                                <th style="width:120px;">Quantity</th>
                                <th>Subtotal</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for id, item in cart_items.items %}
                            <tr style="border-width:2px;">
                                <td>
                                    <div class="d-flex align-items-center gap-3">
                                        {% if item.image %}
                                        <img src="{{ item.image }}" alt="{{ item.title }}" style="width:60px;height:60px;object-fit:contain;border-radius:8px;">
                                        {% endif %}
                                        <span style="font-weight:600;font-size:1.1rem;">{{ item.title }}</span>
                                        {% if item.is_offer %}
                                            <span class="badge bg-info ms-2">Offer</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td style="font-weight:600;">₹ {{ item.price|floatformat:0 }}</td>
                                <td>
                                    <input type="number" name="qty_{{ id }}" value="{{ item.quantity }}" min="1" class="form-control" style="width:80px;display:inline-block;">
                                </td>
                                <td style="font-weight:600;">₹ {{ item.subtotal|floatformat:0 }}</td>
                                <td>
                                    {% if item.is_offer %}
                                        <a href="/cart/remove_offer/{{ id }}/" class="btn btn-outline-danger btn-sm" title="Remove">&times;</a>
                                    {% else %}
                                        <a href="/cart/remove/{{ id }}/" class="btn btn-outline-danger btn-sm" title="Remove">&times;</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                </div>
                <div class="col-4 d-block ms-auto">
                    <div class="card p-4 mb-3" style="border:2px solid #0BD4EB;">
                        <h5 class="mb-3" style="font-weight:700;">Cart Total</h5>
                        <div class="input-group mb-3">
                            <span class="input-group-text bg-info text-white" id="coupon-addon"><i class="bi bi-tag"></i></span>
                            <input type="text" class="form-control" name="coupon" placeholder="Coupon Code" aria-label="Coupon Code" aria-describedby="coupon-addon" value="{{ coupon }}">
                            <button class="btn btn-info" type="submit">Apply Coupon</button>
                        </div>
                        {% if coupon and not discount %}
                        <div class="alert alert-danger p-2">Invalid coupon code.</div>
                        {% elif discount %}
                        <div class="alert alert-success p-2">Coupon applied!</div>
                        {% endif %}
                        <div class="d-flex justify-content-between mb-2"><span>Subtotal:</span><span>₹ {{ subtotal|floatformat:0 }}</span></div>
                        <div class="d-flex justify-content-between mb-2"><span>Discount:</span><span>{% if discount %}- ₹ {{ discount|floatformat:0 }}{% else %}₹ 0{% endif %}</span></div>
                        <div class="d-flex justify-content-between mb-2"><span>Shipping:</span><span>Free</span></div>
                        <div class="d-flex justify-content-between border-top pt-2 mt-2"><span style="font-weight:600;">Total:</span><span style="font-weight:700;font-size:1.2rem;">₹ {{ total|floatformat:0 }}</span></div>
                        <a href="/checkout/" class="btn btn-info w-100 py-2 {% if disable_checkout %}disabled{% endif %}" style="font-weight:600;font-size:1.2rem;" {% if disable_checkout %}tabindex="-1" aria-disabled="true" {% endif %}>Proceed to Checkout</a>
                    </div>
                </div>
            </div>
        </form>
        {% if not user.is_authenticated %}
        <div class="alert alert-info text-center" role="alert">
            Please <a href="/login/">login</a> to proceed with checkout.
        </div>
        {% endif %}
        {% endif %}
    </div>
</section>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('input[type="number"][name^="qty_"]').forEach(function(input) {
            input.addEventListener('change', function() {
                this.form.submit();
            });
        });
    });
</script>
{% endblock %}